<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STARK CLEANE - Sistema Integral Mejorado</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --primary-light: #64b5f6;
            --secondary: #ff6d00;
            --secondary-dark: #e65100;
            --accent: #00c853;
            --danger: #d32f2f;
            --warning: #e74c3c;
            --info: #0288d1;
            --dark: #121212;
            --light: #f5f7fb;
            --gray: #5f6368;
            --gray-light: #e8eaed;
            --sidebar-width: 260px;
            --header-height: 70px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --success: #1cc88a;
            --expired-color: #f8d7da;
            --expiring-soon-color: #fff3cd;
        }
        
        .dark-mode {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-secondary: #9e9e9e;
            --border-color: #333;
            --hover-color: #2a2a2a;
        }
        
        .light-mode {
            --bg-color: #f5f7fb;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #5f6368;
            --border-color: #e0e0e0;
            --hover-color: #f8f9fa;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            overflow-x: hidden;
        }
        
        /* --- LOGIN & REGISTRO MEJORADOS --- */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #000 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 9999;
        }
        
        .login-box {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 15px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            border: 1px solid var(--border-color);
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .logo-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .logo {
            background: var(--primary);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            font-weight: bold;
            margin-right: 15px;
            box-shadow: 0 4px 10px rgba(26, 115, 232, 0.4);
        }
        
        .company-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .input-group {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.05);
        }
        
        .input-group > span {
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.1);
            color: var(--gray);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: none;
            background: transparent;
            color: var(--text-color);
            outline: none;
        }
        
        .btn-full {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.05rem;
            margin-top: 10px;
            transition: var(--transition);
            box-shadow: 0 4px 6px rgba(26, 115, 232, 0.3);
        }
        
        .btn-full:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(26, 115, 232, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: rgba(26, 115, 232, 0.1);
        }
        
        .auth-switch {
            margin-top: 20px;
            font-size: 0.95rem;
            cursor: pointer;
            color: var(--primary);
            text-decoration: underline;
        }
        
        .auth-switch:hover {
            color: var(--primary-dark);
        }
        
        .hidden {
            display: none !important;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-text {
            font-weight: bold;
            font-size: 1.4rem;
            color: white;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 500;
        }
        
        .menu-item:hover,
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 4px solid white;
            color: white;
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }
        
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .submenu.active {
            max-height: 300px;
        }
        
        .submenu-item {
            padding: 12px 20px 12px 60px;
            cursor: pointer;
            transition: var(--transition);
            color: rgba(255, 255, 255, 0.75);
            font-size: 0.9rem;
        }
        
        .submenu-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: var(--transition);
        }
        
        .header {
            height: var(--header-height);
            background: var(--card-bg);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .hamburger {
            display: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }
        
        .header-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .theme-toggle:hover {
            background-color: var(--hover-color);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            transition: var(--transition);
        }
        
        .user-profile:hover {
            background-color: var(--hover-color);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .user-role {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Content Area */
        .content {
            padding: 25px;
        }
        
        .page-title {
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .page-title h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Dashboard Styles */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 25px;
            transition: var(--transition);
            cursor: pointer;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .barberia {
            background: rgba(26, 115, 232, 0.15);
            color: var(--primary);
        }
        
        .billar {
            background: rgba(255, 109, 0, 0.15);
            color: var(--secondary);
        }
        
        .carwash {
            background: rgba(0, 200, 83, 0.15);
            color: var(--accent);
        }
        
        .config {
            background: rgba(211, 47, 47, 0.15);
            color: var(--danger);
        }
        
        .card h3 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 15px;
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .card-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .trend-up {
            color: var(--accent);
        }
        
        .trend-down {
            color: var(--danger);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }
        
        .stat-card h3 {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-trend {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .chart-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 25px;
            border: 1px solid var(--border-color);
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text-color);
        }
        
        /* Page Styles */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page.active {
            display: block;
        }
        
        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 18px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: var(--hover-color);
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
        }
        
        tr:hover {
            background-color: var(--hover-color);
        }
        
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .badge-success {
            background: rgba(0, 200, 83, 0.15);
            color: var(--accent);
        }
        
        .badge-warning {
            background: rgba(255, 160, 0, 0.15);
            color: var(--warning);
        }
        
        .badge-danger {
            background: rgba(211, 47, 47, 0.15);
            color: var(--danger);
        }
        
        .badge-info {
            background: rgba(2, 136, 209, 0.15);
            color: var(--info);
        }
        
        .expired {
            background-color: var(--expired-color) !important;
            font-weight: bold;
        }
        
        .expiring-soon {
            background-color: var(--expiring-soon-color) !important;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-success {
            background: var(--accent);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-custom {
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-custom:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        /* Form Styles */
        .form-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            transition: var(--transition);
            font-size: 0.95rem;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            animation: modalSlideUp 0.4s ease;
        }
        
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        
        .modal-close:hover {
            color: var(--danger);
        }
        
        /* POS Styles */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 18px;
            max-height: 600px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .product-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }
        
        .product-image {
            width: 80px;
            height: 80px;
            background: var(--hover-color);
            border-radius: 10px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--primary);
        }
        
        .product-card h4 {
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .product-card p {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
        }
        
        .cart {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            height: fit-content;
            border: 1px solid var(--border-color);
        }
        
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .cart-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .cart-items {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .cart-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .cart-item-name {
            font-weight: 500;
        }
        
        .cart-item-price {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .cart-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--hover-color);
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .cart-total {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 20px 0;
            text-align: right;
            color: var(--secondary);
        }
        
        /* Vehicle Cards */
        .vehicles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .vehicle-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 5px solid var(--primary);
            border: 1px solid var(--border-color);
        }
        
        .vehicle-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .vehicle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .vehicle-placa {
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .vehicle-type {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .car {
            background: rgba(26, 115, 232, 0.15);
            color: var(--primary);
        }
        
        .jeepeta {
            background: rgba(255, 109, 0, 0.15);
            color: var(--secondary);
        }
        
        .motor {
            background: rgba(0, 200, 83, 0.15);
            color: var(--accent);
        }
        
        .camion {
            background: rgba(211, 47, 47, 0.15);
            color: var(--danger);
        }
        
        .vehicle-details {
            margin-bottom: 20px;
        }
        
        .vehicle-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .vehicle-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 25px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 14px 24px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .hamburger {
                display: block;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .pos-container {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                display: none;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
        
        /* Ticket Styles */
        .ticket {
            background: white;
            color: black;
            padding: 20px;
            font-family: "Courier New", monospace;
            width: 80mm;
            max-width: 80mm;
            margin: 0 auto;
        }
        
        .ticket-header {
            text-align: center;
            border-bottom: 1px dashed #000;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        
        .ticket-items {
            margin: 10px 0;
        }
        
        .ticket-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .ticket-total {
            border-top: 1px dashed #000;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
            text-align: right;
        }
        
        /* Advanced Product Search */
        .search-container {
            position: relative;
        }
        
        .suggestions-container {
            position: absolute;
            width: 100%;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-item:hover {
            background-color: var(--hover-color);
        }
        
        .product-info {
            display: flex;
            flex-direction: column;
        }
        
        .product-name {
            font-weight: 600;
        }
        
        .product-code {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .product-stock {
            font-size: 14px;
            color: var(--accent);
        }
        
        .stock-warning {
            color: var(--danger);
            font-weight: bold;
        }
        
        .no-results {
            padding: 10px 15px;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .search-icon {
            position: absolute;
            right: 10px;
            top: 45px;
            color: var(--text-secondary);
        }
        
        /* Stock Alert Modal */
        .stock-alert-modal {
            background: rgba(0, 0, 0, 0.7);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }
        
        .stock-alert-content {
            background: var(--card-bg);
            border-radius: 15px;
            width: 600px;
            max-width: 95%;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .stock-alert-header {
            background: linear-gradient(135deg, var(--warning), #b92b27);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .stock-alert-body {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .stock-alert-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            background-color: rgba(231, 76, 60, 0.05);
            border-left: 4px solid var(--warning);
        }
        
        .stock-alert-info {
            flex-grow: 1;
        }
        
        .stock-alert-values {
            min-width: 120px;
            text-align: right;
        }
        
        .stock-alert-footer {
            padding: 20px;
            text-align: center;
            border-top: 1px solid var(--border-color);
        }
        
        .stock-alert-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stock-alert-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .product-name-alert {
            font-weight: bold;
            color: #c0392b;
        }
        
        .stock-values {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .stock-value {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .current-stock {
            background-color: var(--expired-color);
            color: #721c24;
        }
        
        .threshold-stock {
            background-color: rgba(28, 200, 138, 0.2);
            color: #155724;
        }
        
        .btn-stock-alert {
            padding: 10px 30px;
            font-size: 16px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--warning), #c0392b);
            border: none;
            color: white;
            border-radius: 50px;
            transition: all 0.3s;
        }
        
        .btn-stock-alert:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        /* Payment Confirmation */
        .payment-modal {
            background: rgba(0, 0, 0, 0.7);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .payment-content {
            background: var(--card-bg);
            border-radius: 15px;
            width: 500px;
            max-width: 95%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .payment-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .payment-body {
            padding: 25px;
        }
        
        .payment-total {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: var(--secondary);
        }
        
        .payment-result {
            background: rgba(28, 200, 138, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: none;
        }
        
        .payment-footer {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--border-color);
        }
        
        /* Daily Report */
        .daily-report-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary-dark));
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-lg);
        }
        
        .report-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .report-label {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .report-details {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .report-detail-item {
            text-align: center;
            padding: 0 10px;
        }
        
        .report-detail-value {
            font-size: 20px;
            font-weight: 600;
        }
        
        .report-detail-label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Data Management */
        .data-persistence-info {
            background-color: rgba(26, 115, 232, 0.1);
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        /* User Management */
        .role-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 5px;
        }
        
        .admin-badge {
            background-color: var(--primary);
            color: white;
        }
        
        .vendedor-badge {
            background-color: var(--accent);
            color: white;
        }
        
        .user-limit-reached {
            background-color: var(--expired-color);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 15px;
        }
        
        /* Toast Notification */
        .toast-area {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast-custom {
            background: var(--card-bg);
            border-left: 4px solid var(--success);
            box-shadow: var(--shadow-lg);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            min-width: 300px;
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s;
            max-height: 80px;
            overflow: hidden;
        }
        
        .toast-error {
            border-left: 4px solid var(--danger);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Sale Form Row */
        .sale-form-row {
            display: grid;
            grid-template-columns: 1fr 100px 120px 120px;
            gap: 10px;
            align-items: end;
        }
        
        .sale-form-row .form-group {
            margin-bottom: 0;
        }
        
        @media (max-width: 992px) {
            .sale-form-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .stock-alert-content {
                width: 90%;
            }
        }
        
        @media (max-width: 576px) {
            .sale-form-row {
                grid-template-columns: 1fr;
            }
            
            .stock-alert-content {
                width: 95%;
            }
        }
        
        /* Profit Info */
        .profit-info {
            font-weight: 600;
            color: var(--accent);
        }
        
        .cost-info {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .margin-info {
            color: var(--info);
            font-weight: 600;
        }
        
        .package-info {
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        .expiration-info {
            font-weight: 600;
        }
        
        .expired-badge {
            background-color: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        .expiring-badge {
            background-color: var(--warning);
            color: #212529;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        
        /* AI Assistant */
        .ai-assistant {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .ai-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }
        
        .ai-button:hover {
            transform: scale(1.1);
        }
        
        .ai-chat {
            position: absolute;
            bottom: 70px;
            left: 0;
            width: 350px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            display: none;
            flex-direction: column;
            max-height: 500px;
        }
        
        .ai-chat.active {
            display: flex;
        }
        
        .ai-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-title {
            font-weight: 600;
            color: var(--primary);
        }
        
        .ai-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .ai-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 350px;
        }
        
        .ai-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .ai-message.user {
            background: rgba(26, 115, 232, 0.1);
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }
        
        .ai-message.assistant {
            background: rgba(0, 0, 0, 0.05);
            border-bottom-left-radius: 2px;
        }
        
        .ai-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .ai-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            margin-right: 10px;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .ai-send {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
    </style>
</head>
<body class="dark-mode">
    <!-- Toast Notification Container -->
    <div class="toast-area" id="toast-container"></div>

    <!-- AI Assistant -->
    <div class="ai-assistant">
        <div class="ai-button" id="aiButton">
            <i class="fas fa-robot"></i>
        </div>
        <div class="ai-chat" id="aiChat">
            <div class="ai-header">
                <div class="ai-title">Asistente IA</div>
                <button class="ai-close" id="aiClose"><i class="fas fa-times"></i></button>
            </div>
            <div class="ai-messages" id="aiMessages">
                <div class="ai-message assistant">
                    ¡Hola! Soy tu asistente de IA. ¿En qué puedo ayudarte?
                </div>
            </div>
            <div class="ai-input">
                <input type="text" id="aiInput" placeholder="Escribe tu pregunta...">
                <button class="ai-send" id="aiSend"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Login System -->
    <div class="login-container" id="authContainer">
        <div class="login-box" id="loginFormBox">
            <div class="logo-header">
                <div class="logo">SC</div>
                <div class="company-name">STARK CLEANE</div>
            </div>
            <h3 style="margin-bottom: 20px">Iniciar Sesión</h3>
            <form id="loginForm">
                <div class="form-group">
                    <label>Usuario</label>
                    <div class="input-group">
                        <span><i class="fas fa-user"></i></span>
                        <input type="text" id="loginUser" class="form-control" placeholder="admin" required />
                    </div>
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <div class="input-group">
                        <span><i class="fas fa-lock"></i></span>
                        <input type="password" id="loginPass" class="form-control" placeholder="******" required />
                    </div>
                </div>
                <button type="submit" class="btn-full">ENTRAR</button>
            </form>
            <div class="auth-switch" onclick="toggleAuth('register')">
                ¿No tienes cuenta? Regístrate aquí
            </div>
            <div id="loginError" style="color: var(--danger); margin-top: 10px; display: none">
                Credenciales incorrectas
            </div>
        </div>
        <div class="login-box hidden" id="registerFormBox">
            <div class="logo-header">
                <div class="logo">SC</div>
                <div class="company-name">REGISTRO</div>
            </div>
            <h3 style="margin-bottom: 20px">Crear Cuenta</h3>
            <form id="registerForm">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <div class="input-group">
                        <span><i class="fas fa-user"></i></span>
                        <input type="text" id="regName" class="form-control" required />
                    </div>
                </div>
                <div class="form-group">
                    <label>Usuario</label>
                    <div class="input-group">
                        <span><i class="fas fa-id-card"></i></span>
                        <input type="text" id="regUser" class="form-control" required />
                    </div>
                </div>
                <div class="form-group">
                    <label>Contraseña (6+ caracteres)</label>
                    <div class="input-group">
                        <span><i class="fas fa-lock"></i></span>
                        <input type="password" id="regPass" class="form-control" required />
                    </div>
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="regRole" class="form-control">
                        <option value="admin">Administrador</option>
                        <option value="barbero">Barbero</option>
                        <option value="vendedor">Vendedor</option>
                    </select>
                </div>
                <button type="submit" class="btn-full">REGISTRARSE</button>
            </form>
            <div class="auth-switch" onclick="toggleAuth('login')">
                ¿Ya tienes cuenta? Inicia sesión
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="container hidden" id="appInterface">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">SC</div>
                <span class="logo-text">STARK CLEANE</span>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-page="barberia">
                    <i class="fas fa-cut"></i>
                    <span>Barbería</span>
                </div>
                <div class="menu-item" data-page="billar">
                    <i class="fas fa-dice"></i>
                    <span>Billar</span>
                </div>
                <div class="menu-item" data-page="carwash">
                    <i class="fas fa-car"></i>
                    <span>Car Wash</span>
                </div>
                <div class="menu-item" data-submenu="configuracion">
                    <i class="fas fa-cog"></i>
                    <span>Configuración</span>
                    <i class="fas fa-chevron-down ml-auto"></i>
                </div>
                <div class="submenu" id="configuracion-submenu">
                    <div class="submenu-item" data-page="config-usuarios">Usuarios</div>
                    <div class="submenu-item" data-page="config-impresora">Impresora</div>
                    <div class="submenu-item" data-page="config-datos">Gestión de Datos</div>
                    <div class="submenu-item" data-page="config-tema">Tema</div>
                </div>
                <div class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Cerrar Sesión</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <div class="hamburger">
                        <i class="fas fa-bars"></i>
                    </div>
                    <div class="header-title" id="headerTitle">Dashboard</div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">Administrador</div>
                            <div class="user-role" id="userRole">Super Admin</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="content">
                <!-- Dashboard -->
                <div class="page active" id="dashboard">
                    <div class="page-title">
                        <h1>Dashboard Principal</h1>
                        <div class="header-actions">
                            <button class="btn btn-outline" id="refreshDashboard">
                                <i class="fas fa-sync-alt"></i> Actualizar
                            </button>
                        </div>
                    </div>
                    <div class="dashboard-cards">
                        <div class="card" data-page="barberia">
                            <div class="card-icon barberia">
                                <i class="fas fa-cut"></i>
                            </div>
                            <h3>Barbería</h3>
                            <p>Gestión de citas y clientes</p>
                            <div class="card-value" id="appointmentsCount">0</div>
                            <div class="card-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="appointmentsTrend">0 citas hoy</span>
                            </div>
                        </div>
                        <div class="card" data-page="billar">
                            <div class="card-icon billar">
                                <i class="fas fa-dice"></i>
                            </div>
                            <h3>Billar</h3>
                            <p>Punto de venta e inventario</p>
                            <div class="card-value" id="salesTotal">RD$ 0</div>
                            <div class="card-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="salesTrend">0% más que ayer</span>
                            </div>
                        </div>
                        <div class="card" data-page="carwash">
                            <div class="card-icon carwash">
                                <i class="fas fa-car"></i>
                            </div>
                            <h3>Car Wash</h3>
                            <p>Lavado de vehículos</p>
                            <div class="card-value" id="vehiclesCount">0</div>
                            <div class="card-trend trend-down">
                                <i class="fas fa-arrow-down"></i>
                                <span id="vehiclesTrend">0 menos que ayer</span>
                            </div>
                        </div>
                        <div class="card" data-page="config-tema">
                            <div class="card-icon config">
                                <i class="fas fa-cog"></i>
                            </div>
                            <h3>Configuración</h3>
                            <p>Personaliza tu sistema</p>
                            <div class="card-value">4</div>
                            <div class="card-trend">
                                <span>Opciones disponibles</span>
                            </div>
                        </div>
                    </div>
                    <div class="stats">
                        <div class="stat-card">
                            <h3>Ingresos de Hoy</h3>
                            <div class="stat-value" id="dailyIncome">RD$ 0</div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="incomeTrend">0% más que ayer</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3>Clientes Atendidos</h3>
                            <div class="stat-value" id="customersCount">0</div>
                            <div class="stat-trend trend-up">
                                <i class="fas fa-arrow-up"></i>
                                <span id="customersTrend">0% más que ayer</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h3>Productos Vendidos</h3>
                            <div class="stat-value" id="productsSold">0</div>
                            <div class="stat-trend trend-down">
                                <i class="fas fa-arrow-down"></i>
                                <span id="productsTrend">0% menos que ayer</span>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Ventas de la Semana</div>
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>

                <!-- Barbería - Página Completa -->
                <div class="page" id="barberia">
                    <div class="page-title">
                        <h1>Barbería</h1>
                        <button class="btn btn-primary" id="newAppointmentBtn">
                            <i class="fas fa-plus"></i> Nueva Cita
                        </button>
                    </div>
                    <!-- Tabs de Barbería -->
                    <div class="tabs">
                        <div class="tab active" data-tab="barberia-citas">Registrar Cliente</div>
                        <div class="tab" data-tab="barberia-lista">Lista de Citas</div>
                        <div class="tab" data-tab="barberia-historial">Historial</div>
                        <div class="tab" data-tab="barberia-pos">Punto de Venta</div>
                    </div>
                    <!-- Contenido de las Tabs -->
                    <div class="tab-content active" id="barberia-citas">
                        <div class="form-container">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nombre"><i class="fas fa-user"></i> Nombre</label>
                                    <input type="text" id="nombre" placeholder="Ingrese el nombre completo" />
                                </div>
                                <div class="form-group">
                                    <label for="telefono"><i class="fas fa-phone"></i> Teléfono</label>
                                    <input type="text" id="telefono" placeholder="Ingrese el teléfono" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="barbero"><i class="fas fa-user-tie"></i> Barbero</label>
                                    <select id="barbero">
                                        <option value="">Seleccione un barbero</option>
                                        <option value="1">Juan Pérez</option>
                                        <option value="2">Miguel Rodríguez</option>
                                        <option value="3">Carlos Sánchez</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="servicio"><i class="fas fa-concierge-bell"></i> Servicio</label>
                                    <select id="servicio">
                                        <option value="">Seleccione un servicio</option>
                                        <option value="1">Corte de cabello - RD$ 250</option>
                                        <option value="2">Afeitado - RD$ 150</option>
                                        <option value="3">Corte y barba - RD$ 350</option>
                                        <option value="4">Tinte - RD$ 400</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="precio"><i class="fas fa-dollar-sign"></i> Precio</label>
                                    <input type="number" id="precio" placeholder="RD$" />
                                </div>
                                <div class="form-group">
                                    <label for="fecha-hora"><i class="fas fa-calendar-alt"></i> Fecha y Hora</label>
                                    <input type="datetime-local" id="fecha-hora" />
                                </div>
                            </div>
                            <button class="btn btn-primary" id="saveAppointmentBtn">
                                <i class="fas fa-save"></i> Guardar Cita
                            </button>
                        </div>
                    </div>
                    <div class="tab-content" id="barberia-lista">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Barbero</th>
                                        <th>Servicio</th>
                                        <th>Hora</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentsTable">
                                    <!-- Las citas se cargarán dinámicamente desde IndexedDB -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="barberia-historial">
                        <div class="form-container">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fecha-busqueda">Fecha</label>
                                    <input type="date" id="fecha-busqueda" />
                                </div>
                                <div class="form-group">
                                    <label for="barbero-busqueda">Barbero</label>
                                    <select id="barbero-busqueda">
                                        <option value="">Todos los barberos</option>
                                        <option value="1">Juan Pérez</option>
                                        <option value="2">Miguel Rodríguez</option>
                                        <option value="3">Carlos Sánchez</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="servicio-busqueda">Servicio</label>
                                <select id="servicio-busqueda">
                                    <option value="">Todos los servicios</option>
                                    <option value="1">Corte de cabello</option>
                                    <option value="2">Afeitado</option>
                                    <option value="3">Corte y barba</option>
                                    <option value="4">Tinte</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="searchHistoryBtn">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <div class="table-container" style="margin-top: 20px">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Barbero</th>
                                        <th>Servicio</th>
                                        <th>Precio</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTable">
                                    <!-- El historial se cargará dinámicamente desde IndexedDB -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="barberia-pos">
                        <div class="page-title">
                            <h2>Punto de Venta - Barbería</h2>
                            <div class="header-actions">
                                <button class="btn btn-outline" id="clearBarberCartBtn">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                            </div>
                        </div>
                        <div class="pos-container">
                            <div>
                                <div class="search-container">
                                    <div class="form-group">
                                        <label for="barber-search">
                                            <i class="fas fa-search"></i> Buscar Servicio
                                        </label>
                                        <input type="text" id="barber-search" placeholder="Escriba el nombre del servicio" />
                                        <i class="fas fa-search search-icon"></i>
                                        <div id="barber-suggestions" class="suggestions-container">
                                            <!-- Las sugerencias se cargarán aquí dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                                <div class="sale-form-row mb-4">
                                    <div class="form-group">
                                        <label for="barber-quantity">Cantidad</label>
                                        <input type="number" id="barber-quantity" class="form-control" value="1" min="1" />
                                    </div>
                                    <div class="form-group">
                                        <label for="barber-price">Precio Unit. (RD$)</label>
                                        <input type="number" step="0.01" id="barber-price" class="form-control" readonly />
                                    </div>
                                    <div class="form-group">
                                        <button id="btn-add-to-barber-cart" class="btn btn-success w-100 h-100">
                                            <i class="fas fa-cart-plus me-1"></i>Añadir
                                        </button>
                                    </div>
                                </div>
                                <h3>Servicios Disponibles</h3>
                                <div class="products-grid" id="barberServicesGrid">
                                    <!-- Los servicios para el POS se cargarán dinámicamente -->
                                </div>
                            </div>
                            <div class="cart">
                                <div class="cart-header">
                                    <div class="cart-title">Carrito de Venta</div>
                                    <div class="badge badge-info" id="barberCartCount">0 servicios</div>
                                </div>
                                <div class="cart-items" id="barberCartItems">
                                    <!-- Los servicios del carrito se cargarán dinámicamente -->
                                </div>
                                <div class="cart-total" id="barberCartTotal">Total: RD$ 0</div>
                                <div class="form-group">
                                    <label for="barber-metodo-pago">Método de Pago</label>
                                    <select id="barber-metodo-pago">
                                        <option value="efectivo">Efectivo</option>
                                        <option value="tarjeta">Tarjeta</option>
                                        <option value="transferencia">Transferencia</option>
                                    </select>
                                </div>
                                <button class="btn btn-success btn-block" id="confirmBarberSaleBtn">
                                    <i class="fas fa-check"></i> Confirmar Venta
                                </button>
                                <button class="btn btn-outline btn-block" id="printBarberTicketBtn">
                                    <i class="fas fa-print"></i> Imprimir Ticket
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billar - Página Completa -->
                <div class="page" id="billar">
                    <div class="page-title">
                        <h1>Billar - Sistema POS Mejorado</h1>
                        <button class="btn btn-secondary" id="newProductBtn">
                            <i class="fas fa-plus"></i> Nuevo Producto
                        </button>
                    </div>
                    <!-- Tabs de Billar -->
                    <div class="tabs">
                        <div class="tab active" data-tab="billar-inventario">Inventario</div>
                        <div class="tab" data-tab="billar-pos">Punto de Venta</div>
                        <div class="tab" data-tab="billar-ventas">Ventas del Día</div>
                        <div class="tab" data-tab="billar-reportes">Reportes</div>
                    </div>
                    <!-- Contenido de las Tabs -->
                    <div class="tab-content active" id="billar-inventario">
                        <div class="data-persistence-info">
                            <h4><i class="fas fa-database me-2"></i>Persistencia de Datos</h4>
                            <p class="mb-0">
                                Los datos del inventario se guardan automáticamente en tu navegador y permanecerán incluso después de reiniciar tu computadora. Los datos son específicos a este navegador y dispositivo.
                            </p>
                        </div>
                        <div class="daily-report-card">
                            <div>
                                <div class="report-label">GANANCIAS DEL DÍA</div>
                                <div class="report-value" id="billar-daily-earnings">RD$0.00</div>
                            </div>
                            <div class="report-details">
                                <div class="report-detail-item">
                                    <div class="report-detail-value" id="billar-daily-sales-count">0</div>
                                    <div class="report-detail-label">VENTAS</div>
                                </div>
                                <div class="report-detail-item">
                                    <div class="report-detail-value" id="billar-daily-items-count">0</div>
                                    <div class="report-detail-label">PRODUCTOS</div>
                                </div>
                                <div class="report-detail-item">
                                    <div class="report-detail-value" id="billar-daily-avg-sale">RD$0.00</div>
                                    <div class="report-detail-label">PROMEDIO</div>
                                </div>
                            </div>
                        </div>
                        <div class="form-container">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="codigo-barra-producto">Código de Barras</label>
                                    <input type="text" id="codigo-barra-producto" placeholder="Ingrese código de barras" />
                                </div>
                                <div class="form-group">
                                    <label for="nombre-producto">Nombre del Producto</label>
                                    <input type="text" id="nombre-producto" placeholder="Ingrese nombre del producto" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="categoria-producto">Categoría</label>
                                    <select id="categoria-producto">
                                        <option value="">Seleccione categoría</option>
                                        <option value="bebidas">Bebidas</option>
                                        <option value="snacks">Snacks</option>
                                        <option value="licores">Licores</option>
                                        <option value="cigarrillos">Cigarrillos</option>
                                        <option value="varios">Varios</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="fecha-ingreso">Fecha de Ingreso</label>
                                    <input type="date" id="fecha-ingreso" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="precio-compra">Precio de Compra (RD$)</label>
                                    <input type="number" step="0.01" id="precio-compra" placeholder="0.00" />
                                </div>
                                <div class="form-group">
                                    <label for="precio-venta">Precio de Venta (RD$)</label>
                                    <input type="number" step="0.01" id="precio-venta" placeholder="0.00" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cantidad-stock">Cantidad en Stock</label>
                                    <input type="number" id="cantidad-stock" placeholder="Cantidad" />
                                </div>
                                <div class="form-group">
                                    <label for="alerta-stock">Alerta de Stock (Umbral)</label>
                                    <input type="number" id="alerta-stock" placeholder="Mínimo" value="5" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fecha-vencimiento">Fecha de Vencimiento</label>
                                    <input type="date" id="fecha-vencimiento" />
                                </div>
                                <div class="form-group">
                                    <label for="unidades-paquete">Unidades por Paquete</label>
                                    <input type="number" id="unidades-paquete" placeholder="Unidades" value="1" />
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="costo-paquete">Costo del Paquete (RD$)</label>
                                    <input type="number" step="0.01" id="costo-paquete" placeholder="0.00" />
                                </div>
                            </div>
                            <button class="btn btn-primary" id="saveProductBtn">
                                <i class="fas fa-save"></i> Guardar Producto
                            </button>
                            <button class="btn btn-secondary hidden" id="updateProductBtn">
                                <i class="fas fa-edit"></i> Actualizar Producto
                            </button>
                            <button class="btn btn-outline hidden" id="cancelProductBtn">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        <div class="page-title" style="margin-top: 20px">
                            <h2>Inventario de Productos</h2>
                            <div class="header-actions">
                                <button class="btn btn-warning" id="btn-show-stock-alert">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Ver Alertas de Stock
                                </button>
                                <button class="btn btn-outline" id="exportProductsBtn">
                                    <i class="fas fa-file-export"></i> Exportar
                                </button>
                                <button class="btn btn-primary" id="addProductBtn">
                                    <i class="fas fa-plus"></i> Agregar Producto
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Producto</th>
                                        <th>Categoría</th>
                                        <th>Precio Compra</th>
                                        <th>Precio Venta</th>
                                        <th>Ganancia</th>
                                        <th>Margen</th>
                                        <th>Stock</th>
                                        <th>Umbral</th>
                                        <th>Vencimiento</th>
                                        <th>Paquete</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTable">
                                    <!-- Los productos se cargarán dinámicamente desde IndexedDB -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="billar-pos">
                        <div class="page-title">
                            <h2>Punto de Venta</h2>
                            <div class="header-actions">
                                <button class="btn btn-outline" id="clearCartBtn">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                            </div>
                        </div>
                        <div class="pos-container">
                            <div>
                                <div class="search-container">
                                    <div class="form-group">
                                        <label for="codigo-barra">
                                            <i class="fas fa-barcode"></i> Buscar Producto
                                        </label>
                                        <input type="text" id="codigo-barra" placeholder="Escriba el nombre o código del producto" />
                                        <i class="fas fa-search search-icon"></i>
                                        <div id="product-suggestions" class="suggestions-container">
                                            <!-- Las sugerencias se cargarán aquí dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                                <div class="sale-form-row mb-4">
                                    <div class="form-group">
                                        <label for="sale-quantity">Cantidad</label>
                                        <input type="number" id="sale-quantity" class="form-control" value="1" min="1" />
                                    </div>
                                    <div class="form-group">
                                        <label for="sale-price">Precio Unit. (RD$)</label>
                                        <input type="number" step="0.01" id="sale-price" class="form-control" readonly />
                                    </div>
                                    <div class="form-group">
                                        <button id="btn-add-to-cart" class="btn btn-success w-100 h-100">
                                            <i class="fas fa-cart-plus me-1"></i>Añadir
                                        </button>
                                    </div>
                                </div>
                                <h3>Productos Disponibles</h3>
                                <div class="products-grid" id="productsGrid">
                                    <!-- Los productos para el POS se cargarán dinámicamente desde IndexedDB -->
                                </div>
                            </div>
                            <div class="cart">
                                <div class="cart-header">
                                    <div class="cart-title">Carrito de Venta</div>
                                    <div class="badge badge-info" id="cartCount">0 productos</div>
                                </div>
                                <div class="cart-items" id="cartItems">
                                    <!-- Los productos del carrito se cargarán dinámicamente -->
                                </div>
                                <div class="cart-total" id="cartTotal">Total: RD$ 0</div>
                                <div class="form-group">
                                    <label for="metodo-pago">Método de Pago</label>
                                    <select id="metodo-pago">
                                        <option value="efectivo">Efectivo</option>
                                        <option value="tarjeta">Tarjeta</option>
                                        <option value="transferencia">Transferencia</option>
                                    </select>
                                </div>
                                <button class="btn btn-success btn-block" id="confirmSaleBtn">
                                    <i class="fas fa-check"></i> Confirmar Venta
                                </button>
                                <button class="btn btn-outline btn-block" id="printTicketBtn">
                                    <i class="fas fa-print"></i> Imprimir Ticket
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="tab-content" id="billar-ventas">
                        <div class="page-title">
                            <h2>Ventas del Día</h2>
                            <div class="header-actions">
                                <button class="btn btn-outline" id="filterSalesBtn">
                                    <i class="fas fa-filter"></i> Filtrar
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Hora</th>
                                        <th>Total</th>
                                        <th>Productos Vendidos</th>
                                        <th>Método de Pago</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTable">
                                    <!-- Las ventas se cargarán dinámicamente desde IndexedDB -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="billar-reportes">
                        <div class="page-title">
                            <h2>Reportes</h2>
                            <div class="header-actions">
                                <button class="btn btn-success" id="exportExcelBtn">
                                    <i class="fas fa-file-excel"></i> Exportar a Excel
                                </button>
                                <button class="btn btn-danger" id="exportPdfBtn">
                                    <i class="fas fa-file-pdf"></i> Exportar a PDF
                                </button>
                            </div>
                        </div>
                        <div class="form-container">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fecha-inicio">Fecha Inicio</label>
                                    <input type="date" id="fecha-inicio" />
                                </div>
                                <div class="form-group">
                                    <label for="fecha-fin">Fecha Fin</label>
                                    <input type="date" id="fecha-fin" />
                                </div>
                            </div>
                            <button class="btn btn-primary" id="generateReportBtn">
                                <i class="fas fa-chart-bar"></i> Generar Reporte
                            </button>
                        </div>
                        <div class="stats" style="margin-top: 20px">
                            <div class="stat-card">
                                <h3>Total Vendido</h3>
                                <div class="stat-value" id="totalSold">RD$ 0</div>
                                <div class="stat-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span id="soldTrend">0% más que la semana pasada</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>Producto Más Vendido</h3>
                                <div class="stat-value" id="topProduct">-</div>
                                <div class="stat-trend">
                                    <span id="topProductCount">0 unidades</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <h3>Categoría Más Popular</h3>
                                <div class="stat-value" id="topCategory">-</div>
                                <div class="stat-trend">
                                    <span id="topCategoryPercent">0% de las ventas</span>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">Ventas por Categoría</div>
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div class="form-group">
                            <label>Leer código de barras (simulación)</label>
                            <input type="text" id="barcode-reader" class="form-control" placeholder="Escanear código de barras aquí" />
                        </div>
                    </div>
                </div>

                <!-- Car Wash - Página Completa -->
                <div class="page" id="carwash">
                    <div class="page-title">
                        <h1>Car Wash</h1>
                        <button class="btn btn-success" id="newVehicleBtn">
                            <i class="fas fa-plus"></i> Nuevo Vehículo
                        </button>
                    </div>
                    <!-- Tabs de Car Wash -->
                    <div class="tabs">
                        <div class="tab active" data-tab="carwash-registro">Registrar Vehículo</div>
                        <div class="tab" data-tab="carwash-proceso">Vehículos en Proceso</div>
                        <div class="tab" data-tab="carwash-entregados">Vehículos Entregados</div>
                        <div class="tab" data-tab="carwash-historial">Historial</div>
                        <div class="tab" data-tab="carwash-pos">Punto de Venta</div>
                    </div>
                    <!-- Contenido de las Tabs -->
                    <div class="tab-content active" id="carwash-registro">
                        <div class="form-container">
                            <div class="form-group">
                                <label for="tipo-vehiculo"><i class="fas fa-car"></i> Tipo de Vehículo</label>
                                <select id="tipo-vehiculo">
                                    <option value="">Seleccione tipo</option>
                                    <option value="carro">Carro</option>
                                    <option value="jeepeta">Jeepeta</option>
                                    <option value="motor">Motor</option>
                                    <option value="camion">Camión</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="placa"><i class="fas fa-id-card"></i> Placa</label>
                                <input type="text" id="placa" placeholder="Ingrese la placa" />
                            </div>
                            <div class="form-group">
                                <label for="servicio-vehiculo"><i class="fas fa-concierge-bell"></i> Servicio</label>
                                <select id="servicio-vehiculo">
                                    <option value="">Seleccione servicio</option>
                                    <option value="lavado-basico">Lavado Básico - RD$ 300</option>
                                    <option value="lavado-completo">Lavado Completo - RD$ 450</option>
                                    <option value="lavado-motor">Lavado de Motor - RD$ 200</option>
                                    <option value="pulido">Pulido - RD$ 600</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="precio-vehiculo"><i class="fas fa-dollar-sign"></i> Precio</label>
                                    <input type="number" id="precio-vehiculo" placeholder="RD$" />
                                </div>
                                <div class="form-group">
                                    <label for="empleado-vehiculo"><i class="fas fa-user"></i> Empleado (Opcional)</label>
                                    <select id="empleado-vehiculo">
                                        <option value="">Seleccione empleado</option>
                                        <option value="1">Pedro Martínez</option>
                                        <option value="2">José Rodríguez</option>
                                        <option value="3">Ana Sánchez</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="hora-entrada"><i class="fas fa-clock"></i> Hora de Entrada</label>
                                <input type="datetime-local" id="hora-entrada" />
                            </div>
                            <button class="btn btn-success" id="saveVehicleBtn">
                                <i class="fas fa-save"></i> Registrar Vehículo
                            </button>
                        </div>
                    </div>
                    <div class="tab-content" id="carwash-proceso">
                        <div class="vehicles-grid" id="vehiclesGrid">
                            <!-- Los vehículos en proceso se cargarán dinámicamente desde IndexedDB -->
                        </div>
                    </div>
                    <div class="tab-content" id="carwash-entregados">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Placa</th>
                                        <th>Tipo</th>
                                        <th>Servicio</th>
                                        <th>Precio</th>
                                        <th>Hora Entrada</th>
                                        <th>Hora Salida</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="completedVehiclesTable">
                                    <!-- Los vehículos entregados se cargarán dinámicamente desde IndexedDB -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="carwash-historial">
                        <div class="form-container">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fecha-carwash">Fecha</label>
                                    <input type="date" id="fecha-carwash" />
                                </div>
                                <div class="form-group">
                                    <label for="tipo-filtro">Tipo de Vehículo</label>
                                    <select id="tipo-filtro">
                                        <option value="">Todos los tipos</option>
                                        <option value="carro">Carro</option>
                                        <option value="jeepeta">Jeepeta</option>
                                        <option value="motor">Motor</option>
                                        <option value="camion">Camión</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="servicio-filtro">Servicio</label>
                                <select id="servicio-filtro">
                                    <option value="">Todos los servicios</option>
                                    <option value="lavado-basico">Lavado Básico</option>
                                    <option value="lavado-completo">Lavado Completo</option>
                                    <option value="lavado-motor">Lavado de Motor</option>
                                    <option value="pulido">Pulido</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" id="searchCarwashBtn">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <div class="table-container" style="margin-top: 20px">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Placa</th>
                                        <th>Tipo</th>
                                        <th>Servicio</th>
                                        <th>Precio</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="carwashHistoryTable">
                                    <!-- El historial se cargará dinámicamente desde IndexedDB -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="carwash-pos">
                        <div class="page-title">
                            <h2>Punto de Venta - Car Wash</h2>
                            <div class="header-actions">
                                <button class="btn btn-outline" id="clearCarwashCartBtn">
                                    <i class="fas fa-trash"></i> Limpiar
                                </button>
                            </div>
                        </div>
                        <div class="pos-container">
                            <div>
                                <div class="search-container">
                                    <div class="form-group">
                                        <label for="carwash-search">
                                            <i class="fas fa-search"></i> Buscar Servicio
                                        </label>
                                        <input type="text" id="carwash-search" placeholder="Escriba el nombre del servicio" />
                                        <i class="fas fa-search search-icon"></i>
                                        <div id="carwash-suggestions" class="suggestions-container">
                                            <!-- Las sugerencias se cargarán aquí dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                                <div class="sale-form-row mb-4">
                                    <div class="form-group">
                                        <label for="carwash-quantity">Cantidad</label>
                                        <input type="number" id="carwash-quantity" class="form-control" value="1" min="1" />
                                    </div>
                                    <div class="form-group">
                                        <label for="carwash-price">Precio Unit. (RD$)</label>
                                        <input type="number" step="0.01" id="carwash-price" class="form-control" readonly />
                                    </div>
                                    <div class="form-group">
                                        <button id="btn-add-to-carwash-cart" class="btn btn-success w-100 h-100">
                                            <i class="fas fa-cart-plus me-1"></i>Añadir
                                        </button>
                                    </div>
                                </div>
                                <h3>Servicios Disponibles</h3>
                                <div class="products-grid" id="carwashServicesGrid">
                                    <!-- Los servicios para el POS se cargarán dinámicamente -->
                                </div>
                            </div>
                            <div class="cart">
                                <div class="cart-header">
                                    <div class="cart-title">Carrito de Venta</div>
                                    <div class="badge badge-info" id="carwashCartCount">0 servicios</div>
                                </div>
                                <div class="cart-items" id="carwashCartItems">
                                    <!-- Los servicios del carrito se cargarán dinámicamente -->
                                </div>
                                <div class="cart-total" id="carwashCartTotal">Total: RD$ 0</div>
                                <div class="form-group">
                                    <label for="carwash-metodo-pago">Método de Pago</label>
                                    <select id="carwash-metodo-pago">
                                        <option value="efectivo">Efectivo</option>
                                        <option value="tarjeta">Tarjeta</option>
                                        <option value="transferencia">Transferencia</option>
                                    </select>
                                </div>
                                <button class="btn btn-success btn-block" id="confirmCarwashSaleBtn">
                                    <i class="fas fa-check"></i> Confirmar Venta
                                </button>
                                <button class="btn btn-outline btn-block" id="printCarwashTicketBtn">
                                    <i class="fas fa-print"></i> Imprimir Ticket
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración - Usuarios -->
                <div class="page" id="config-usuarios">
                    <div class="page-title">
                        <h1>Configuración - Usuarios</h1>
                        <div class="header-actions">
                            <span id="logged-user" class="badge bg-primary">
                                <span id="current-username">admin</span>
                                <span class="role-badge admin-badge">Admin</span>
                            </span>
                        </div>
                    </div>
                    <div class="form-container">
                        <div class="table-container">
                            <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-user-shield me-2"></i>Configuración de Usuarios
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-custom table-hover">
                                        <thead>
                                            <tr>
                                                <th>Usuario</th>
                                                <th>Rol</th>
                                                <th>Último Acceso</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="users-table-body">
                                            <!-- Los usuarios se cargarán aquí dinámicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración - Gestión de Datos -->
                <div class="page" id="config-datos">
                    <div class="page-title">
                        <h1>Configuración - Gestión de Datos</h1>
                        <div class="header-actions">
                            <span id="datos-logged-user" class="badge bg-primary">
                                <span id="datos-current-username">admin</span>
                                <span class="role-badge admin-badge">Admin</span>
                            </span>
                        </div>
                    </div>
                    <div class="form-container">
                        <div class="data-persistence-info">
                            <h4><i class="fas fa-database me-2"></i>Persistencia de Datos</h4>
                            <p class="mb-0">
                                Tus datos se guardan automáticamente en tu navegador y permanecerán incluso después de reiniciar tu computadora. Los datos son específicos a este navegador y dispositivo.
                            </p>
                        </div>
                        <div class="card mb-4">
                            <div class="card-header card-header-custom">
                                <i class="fas fa-database me-2"></i>Gestión de Datos
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <button id="btn-backup" class="btn btn-success w-100 btn-custom">
                                            <i class="fas fa-download me-1"></i>Realizar Backup
                                        </button>
                                    </div>
                                    <div class="col-md-4">
                                        <button id="btn-restore" class="btn btn-warning w-100 btn-custom">
                                            <i class="fas fa-upload me-1"></i>Restaurar Datos
                                        </button>
                                    </div>
                                    <div class="col-md-4">
                                        <button id="btn-reset" class="btn btn-danger w-100 btn-custom">
                                            <i class="fas fa-trash-alt me-1"></i>Restablecer Sistema
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración - Tema -->
                <div class="page" id="config-tema">
                    <div class="page-title">
                        <h1>Configuración - Tema</h1>
                    </div>
                    <div class="form-container">
                        <div class="form-group">
                            <label for="select-tema">Seleccionar Tema</label>
                            <select id="select-tema">
                                <option value="dark">Oscuro</option>
                                <option value="light">Claro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Vista Previa</label>
                            <div class="card">
                                <div class="card-icon barberia">
                                    <i class="fas fa-cut"></i>
                                </div>
                                <h3>Ejemplo de Tarjeta</h3>
                                <p>Esta es una vista previa del tema seleccionado</p>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="saveThemeBtn">
                            <i class="fas fa-save"></i> Guardar Configuración
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta de Stock -->
    <div id="stock-alert-modal" class="stock-alert-modal hidden">
        <div class="stock-alert-content">
            <div class="stock-alert-header">
                <div class="stock-alert-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Alertas de Inventario
                </div>
                <div class="stock-alert-subtitle">
                    Productos con stock bajo, próximos a vencer o vencidos
                </div>
            </div>
            <div class="stock-alert-body" id="stock-alert-items">
                <!-- Los productos con alertas se mostrarán aquí -->
            </div>
            <div class="stock-alert-footer">
                <button id="btn-close-stock-alert" class="btn-stock-alert">
                    <i class="fas fa-check me-1"></i>Entendido
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Pago -->
    <div id="payment-modal" class="payment-modal hidden">
        <div class="payment-content">
            <div class="payment-header">
                <h3><i class="fas fa-cash-register me-2"></i>Confirmar Venta</h3>
            </div>
            <div class="payment-body">
                <h4 class="text-center mb-4">
                    Total a pagar:
                    <span class="text-primary" id="modal-total">RD$0.00</span>
                </h4>
                <div class="mb-4">
                    <label class="form-label">Monto recibido (RD$)</label>
                    <input type="number" step="0.01" class="form-control form-control-lg" id="payment-amount" placeholder="0.00" />
                </div>
                <div id="payment-result" class="payment-result">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Total venta:</span>
                        <span id="payment-sale-total">RD$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Pagado:</span>
                        <span id="payment-received">RD$0.00</span>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between fw-bold">
                        <span>Cambio:</span>
                        <span class="text-success" id="payment-change">RD$0.00</span>
                    </div>
                </div>
                <div class="payment-footer">
                    <button id="btn-cancel-payment" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button id="btn-confirm-payment" class="btn btn-success btn-lg">
                        <i class="fas fa-check me-1"></i>Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =============================================
        // MÓDULO DB.JS - IndexedDB robusto
        // =============================================
        const DB_NAME = "STARK_CLEANE_DB";
        const DB_VERSION = 4;
        let _db = null;

        async function openDB() {
          if (_db) return _db;
          return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = (e) => {
              const db = e.target.result;
              const ensure = (name, opts = { keyPath: 'id', autoIncrement: true }, indexes = []) => {
                if (!db.objectStoreNames.contains(name)) {
                  const st = db.createObjectStore(name, opts);
                  indexes.forEach(ix => {
                    try { st.createIndex(ix.name, ix.keyPath, ix.options || { unique: false }); }
                    catch(e) { console.warn("Index create error", ix, e); }
                  });
                }
              };

              ensure("productos", { keyPath: "id", autoIncrement: true }, [
                { name: "por_codigoBarra", keyPath: "codigoBarra" },
                { name: "por_nombre", keyPath: "nombre" }
              ]);
              ensure("ventas", { keyPath: "id", autoIncrement: true }, [{ name: "por_fecha", keyPath: "fecha" }]);
              ensure("billar_mesas", { keyPath: "id", autoIncrement: true }, [{ name: "por_estado", keyPath: "estado" }]);
              ensure("carwash_vehiculos", { keyPath: "id", autoIncrement: true }, [
                { name: "por_placa", keyPath: "placa" }, { name: "por_estado", keyPath: "estado" }
              ]);
              ensure("carwash_services", { keyPath: "id", autoIncrement: true }, [{ name: "por_codigo", keyPath: "codigo" }]);
              ensure("barberia_citas", { keyPath: "id", autoIncrement: true }, [{ name: "por_fecha", keyPath: "fecha" }]);
              ensure("barberia_services", { keyPath: "id", autoIncrement: true }, [{ name: "por_codigo", keyPath: "codigo" }]);
              ensure("usuarios", { keyPath: "id", autoIncrement: true }, [{ name: "por_usuario", keyPath: "username" }]);
              ensure("config", { keyPath: "key" });
              ensure("backups", { keyPath: "id", autoIncrement: true });
            };

            req.onsuccess = (e) => {
              _db = e.target.result;
              _db.onversionchange = () => { _db.close(); _db = null; };
              resolve(_db);
            };
            req.onerror = (e) => { console.error("IndexedDB open error", e.target.error); reject(e.target.error); };
          });
        }

        async function storeTx(name, mode = "readonly") {
          const db = await openDB();
          return db.transaction(name, mode).objectStore(name);
        }

        async function addItem(storeName, payload) {
          const store = await storeTx(storeName, "readwrite");
          return new Promise((res, rej) => {
            const r = store.add(payload);
            r.onsuccess = () => res(r.result);
            r.onerror = (e) => rej(e.target.error);
          });
        }
        
        async function putItem(storeName, payload) {
          const store = await storeTx(storeName, "readwrite");
          return new Promise((res, rej) => {
            const r = store.put(payload);
            r.onsuccess = () => res(r.result);
            r.onerror = (e) => rej(e.target.error);
          });
        }
        
        async function getItem(storeName, key) {
          const store = await storeTx(storeName, "readonly");
          return new Promise((res, rej) => {
            const r = store.get(key);
            r.onsuccess = () => res(r.result);
            r.onerror = (e) => rej(e.target.error);
          });
        }
        
        async function deleteItem(storeName, key) {
          const store = await storeTx(storeName, "readwrite");
          return new Promise((res, rej) => {
            const r = store.delete(key);
            r.onsuccess = () => res(true);
            r.onerror = (e) => rej(e.target.error);
          });
        }
        
        async function getAll(storeName) {
          const store = await storeTx(storeName, "readonly");
          return new Promise((res, rej) => {
            const r = store.getAll();
            r.onsuccess = () => res(r.result);
            r.onerror = (e) => rej(e.target.error);
          });
        }
        
        async function getByIndex(storeName, indexName, value) {
          const store = await storeTx(storeName, "readonly");
          return new Promise((res, rej) => {
            try {
              const idx = store.index(indexName);
              const r = idx.get(value);
              r.onsuccess = () => res(r.result);
              r.onerror = (e) => rej(e.target.error);
            } catch (err) { res(null); }
          });
        }
        
        async function getAllByIndex(storeName, indexName, query) {
          const store = await storeTx(storeName, "readonly");
          return new Promise((res, rej) => {
            try {
              const idx = store.index(indexName);
              const r = idx.getAll(query);
              r.onsuccess = () => res(r.result);
              r.onerror = (e) => rej(e.target.error);
            } catch (err) { res([]); }
          });
        }

        async function exportAll() {
          const stores = ["productos","ventas","billar_mesas","carwash_vehiculos","carwash_services","barberia_citas","barberia_services","usuarios","config"];
          const out = {};
          for (const s of stores) out[s] = await getAll(s);
          return out;
        }
        
        async function importData(obj) {
          for (const name of Object.keys(obj || {})) {
            try {
              const items = obj[name];
              if (!items || !items.length) continue;
              for (const it of items) {
                await putItem(name, it);
              }
            } catch(e) { console.warn("Import error", e); }
          }
          return true;
        }

        // expose global default
        const DB = { openDB, addItem, putItem, getItem, deleteItem, getAll, getByIndex, getAllByIndex, exportAll, importData };
        window.DB = DB;

        // =============================================
        // MÓDULO AUTH.JS - Sistema de autenticación
        // =============================================
        const MAX_USERS = 3;
        let currentUser = null;

        async function login(username, password) {
          try {
            const users = await getAll('usuarios');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
              currentUser = user;
              
              // Actualizar último acceso
              user.lastAccess = new Date().toISOString();
              await putItem('usuarios', user);
              
              // Mostrar interfaz principal
              document.getElementById('authContainer').classList.add('hidden');
              document.getElementById('appInterface').classList.remove('hidden');
              
              // Actualizar información de usuario en UI
              document.getElementById('userName').textContent = user.nombre;
              document.getElementById('userRole').textContent = user.rol;
              document.getElementById('userAvatar').textContent = user.nombre.charAt(0).toUpperCase();
              
              // Guardar en localStorage
              localStorage.setItem('currentUser', JSON.stringify({
                username: user.username,
                password: user.password
              }));
              
              // Inicializar aplicación
              if (window.initApp) {
                await window.initApp();
              }
              
              showToast('Sesión iniciada correctamente');
              return { success: true, user };
            } else {
              return { success: false, error: "Credenciales incorrectas" };
            }
          } catch (error) {
            console.error("Login error:", error);
            return { success: false, error: "Error del sistema" };
          }
        }

        async function register(userData) {
          try {
            const { nombre, username, password, rol } = userData;
            
            if (password.length < 6) {
              return { success: false, error: "La contraseña debe tener al menos 6 caracteres" };
            }
            
            // Verificar límite de usuarios
            const users = await getAll('usuarios');
            if (users.length >= MAX_USERS) {
              return { success: false, error: `Límite de usuarios alcanzado (máximo ${MAX_USERS})` };
            }
            
            // Verificar usuario duplicado
            if (users.find(u => u.username === username)) {
              return { success: false, error: "El usuario ya existe" };
            }
            
            // Crear nuevo usuario
            const newUser = {
              nombre,
              username,
              password,
              rol,
              lastAccess: new Date().toISOString(),
              fechaRegistro: new Date().toISOString()
            };
            
            await addItem('usuarios', newUser);
            
            return { success: true, user: newUser };
            
          } catch (error) {
            console.error("Register error:", error);
            return { success: false, error: "Error al registrar usuario" };
          }
        }

        function logout() {
          currentUser = null;
          document.getElementById('authContainer').classList.remove('hidden');
          document.getElementById('appInterface').classList.add('hidden');
          document.getElementById('loginForm').reset();
          localStorage.removeItem('currentUser');
        }

        function getCurrentUser() {
          return currentUser;
        }

        // Inicializar usuarios por defecto
        async function initDefaultUsers() {
          try {
            const users = await getAll('usuarios');
            if (users.length === 0) {
              await addItem('usuarios', {
                nombre: "Administrador",
                username: "admin",
                password: "123456",
                rol: "admin",
                lastAccess: new Date().toISOString(),
                fechaRegistro: new Date().toISOString()
              });
              console.log("Usuario admin por defecto creado");
            }
          } catch (error) {
            console.error("Error creating default users:", error);
          }
        }

        // Exposición global
        window.Auth = { login, register, logout, getCurrentUser, initDefaultUsers };

        // =============================================
        // MÓDULO APP.JS - SPA bootstrap
        // =============================================
        const Views = {
          dashboard: document.getElementById('dashboard'),
          barberia: document.getElementById('barberia'), 
          billar: document.getElementById('billar'),
          carwash: document.getElementById('carwash'),
          'config-usuarios': document.getElementById('config-usuarios'),
          'config-datos': document.getElementById('config-datos'),
          'config-tema': document.getElementById('config-tema')
        };

        function hideAllViews() { 
          Object.values(Views).forEach(v => {
            if (v) v.classList.remove('active');
          });
        }

        function showView(name) {
          hideAllViews();
          if (Views[name]) {
            Views[name].classList.add('active');
            
            // Actualizar título del header
            const headerTitle = document.getElementById('headerTitle');
            if (headerTitle) {
              const pageTitles = {
                dashboard: "Dashboard",
                barberia: "Barbería", 
                billar: "Billar",
                carwash: "Car Wash",
                'config-usuarios': "Configuración - Usuarios",
                'config-datos': "Configuración - Gestión de Datos",
                'config-tema': "Configuración - Tema"
              };
              headerTitle.textContent = pageTitles[name] || name;
            }
          }
          
          // Focus en búsqueda para vistas POS
          if (name === 'billar' || name === 'barberia' || name === 'carwash') {
            setTimeout(() => {
              const barcodeInput = document.getElementById('barcodeInput');
              if (barcodeInput) barcodeInput.focus();
            }, 160);
          }
        }

        async function attachMenuListeners() {
          // Usar tu menú lateral existente
          document.querySelectorAll('.menu-item[data-page]').forEach(item => {
            item.addEventListener('click', (ev) => {
              ev.preventDefault();
              const pageId = item.getAttribute('data-page');
              if (pageId) {
                showView(pageId);
                
                // Actualizar estado activo del menú
                document.querySelectorAll('.menu-item').forEach(mi => {
                  mi.classList.remove('active');
                });
                item.classList.add('active');
              }
            });
          });

          // Manejar submenús
          document.querySelectorAll('.menu-item[data-submenu]').forEach(item => {
            item.addEventListener('click', (ev) => {
              const submenuId = item.getAttribute('data-submenu');
              if (submenuId) {
                const submenu = document.getElementById(`${submenuId}-submenu`);
                if (submenu) {
                  submenu.classList.toggle('active');
                }
              }
            });
          });

          // Navegación de tabs
          document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
              const parent = this.closest('.tabs');
              parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
              this.classList.add('active');
              
              const tabId = this.getAttribute('data-tab');
              const container = this.closest('.page');
              container.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
              });
              document.getElementById(tabId).classList.add('active');
            });
          });
        }

        async function initCharts() {
          // Inicializar Chart.js si está disponible
          if (window.Chart) {
            const ctx = document.getElementById('salesChart')?.getContext('2d');
            if (ctx) {
              new Chart(ctx, {
                type: 'line',
                data: { 
                  labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                  datasets: [{ 
                    label: 'Ventas Semanales', 
                    data: [1200, 1900, 1500, 2000, 1800, 2200, 2400],
                    borderColor: '#1a73e8',
                    backgroundColor: 'rgba(26, 115, 232, 0.1)',
                    tension: 0.4
                  }]
                },
                options: { 
                  responsive: true,
                  plugins: {
                    legend: {
                      position: 'top',
                    }
                  }
                }
              });
            }
            
            // Gráfico de categorías
            const categoryCtx = document.getElementById('categoryChart')?.getContext('2d');
            if (categoryCtx) {
              new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                  labels: ['Bebidas', 'Snacks', 'Licores', 'Cigarrillos', 'Varios'],
                  datasets: [{
                    data: [35, 25, 20, 15, 5],
                    backgroundColor: [
                      '#1a73e8', '#ff6d00', '#00c853', '#d32f2f', '#0288d1'
                    ]
                  }]
                }
              });
            }
          }
        }

        async function refreshDashboard() {
          try {
            const ventas = await getAll('ventas');
            const productos = await getAll('productos');
            const vehiculos = await getAll('carwash_vehiculos');
            const citas = await getAll('barberia_citas');
            
            // Actualizar contadores del dashboard
            if (document.getElementById('salesTotal')) {
              const totalVentas = ventas.reduce((sum, v) => sum + (v.total || 0), 0);
              document.getElementById('salesTotal').textContent = `RD$ ${totalVentas.toLocaleString()}`;
            }
            
            if (document.getElementById('vehiclesCount')) {
              const activos = vehiculos.filter(v => v.estado !== 'entregado').length;
              document.getElementById('vehiclesCount').textContent = activos;
            }
            
            if (document.getElementById('appointmentsCount')) {
              const hoy = new Date().toISOString().split('T')[0];
              const citasHoy = citas.filter(c => c.fecha && c.fecha.startsWith(hoy)).length;
              document.getElementById('appointmentsCount').textContent = citasHoy;
            }
            
            // Alertas de stock bajo
            const stockBajo = productos.filter(p => p.stock <= (p.alerta_stock || 5));
            if (document.getElementById('dash-stock-alerts')) {
              document.getElementById('dash-stock-alerts').textContent = stockBajo.length;
            }
            
          } catch(e) { 
            console.warn("Error refreshing dashboard:", e); 
          }
        }

        async function initApp() {
          try {
            await openDB();
            await attachMenuListeners();
            await initCharts();
            
            // Inicializar módulos si están disponibles
            window.Barcode?.init();
            window.POS?.init();
            window.Jarvis?.init({ wakeWord: 'jarvis' });
            
            // Mostrar dashboard por defecto
            showView('dashboard');
            
            // Actualizar dashboard cada 5 segundos
            setInterval(refreshDashboard, 5000);
            await refreshDashboard();
            
            console.log("STARK CLEANE System initialized successfully");
            
          } catch (error) {
            console.error("Error initializing app:", error);
          }
        }

        // Exposición global
        window.showView = showView;
        window.initApp = initApp;
        window.refreshDashboard = refreshDashboard;

        // =============================================
        // MÓDULO BARCODE.JS - scanner HID handler
        // =============================================
        const Barcode = (() => {
          let inputEl = null;
          function createHidden() {
            inputEl = document.createElement('input');
            inputEl.id = 'barcodeInput';
            inputEl.autocomplete = 'off';
            inputEl.style.position = 'absolute';
            inputEl.style.left = '-9999px';
            document.body.appendChild(inputEl);
          }
          
          function init() {
            inputEl = document.getElementById('barcodeInput') || createHidden();
            inputEl.addEventListener('keydown', onKey);
            document.addEventListener('click', ()=> inputEl && inputEl.focus());
            inputEl.focus();
          }
          
          async function onKey(e) {
            if (e.key === 'Enter') {
              const code = e.target.value.trim();
              e.target.value = '';
              if (!code) return;
              const active = document.querySelector('[data-active-module]')?.getAttribute('data-active-module') || 'billar';
              try { 
                await window.POS.addByBarcode(code, active); 
              } catch(err) { 
                console.warn(err); 
                showToast('Código no encontrado: ' + code, 'error');
              }
            }
          }
          
          return { init };
        })();
        
        window.Barcode = Barcode;

        // =============================================
        // MÓDULO MODAL-CONFIRM.JS - modal
        // =============================================
        function injectConfirmHtml() {
          if (document.getElementById('confirmModal')) return;
          const wrapper = document.createElement('div');
          wrapper.innerHTML = `
          <div id="confirmModal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;">
            <div id="confirmBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,0.45)"></div>
            <div id="confirmCard" style="position:relative;background:#fff;width:760px;max-width:95%;border-radius:8px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
              <header style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding-bottom:8px;">
                <h3 id="confirmTitle">Confirmar Venta</h3>
                <button id="confirmClose" style="border:0;background:transparent;font-size:18px;cursor:pointer">✕</button>
              </header>
              <div id="confirmBody" style="padding:12px 0;">
                <div id="confirmItems" style="max-height:260px;overflow:auto;"></div>
                <div id="confirmSummary" style="margin-top:8px;">
                  <div>Subtotal: <span id="confirmSubtotal">RD$0.00</span></div>
                  <div>Impuesto: <span id="confirmTax">RD$0.00</span></div>
                  <div style="font-size:1.3em;">Total: <strong id="confirmTotal">RD$0.00</strong></div>
                </div>
                <div style="margin-top:10px;">
                  <label>Método de pago:</label>
                  <select id="confirmPayment"><option value="efectivo">Efectivo</option><option value="tarjeta">Tarjeta</option><option value="transferencia">Transferencia</option></select>
                </div>
              </div>
              <footer style="display:flex;justify-content:flex-end;gap:8px;padding-top:8px;border-top:1px solid #eee;margin-top:6px;">
                <button id="confirmCancel" style="padding:8px 12px;border-radius:6px;border:0;background:#f2f2f2">Cancelar</button>
                <button id="confirmAccept" style="padding:8px 12px;border-radius:6px;border:0;background:#1A73E8;color:#fff">Confirmar y Imprimir</button>
              </footer>
            </div>
          </div>`;
          document.body.appendChild(wrapper);
          document.getElementById('confirmClose').onclick = closeConfirm;
          document.getElementById('confirmCancel').onclick = closeConfirm;
        }

        function openConfirm(data, onConfirm) {
          injectConfirmHtml();
          const modal = document.getElementById('confirmModal');
          const itemsEl = document.getElementById('confirmItems');
          itemsEl.innerHTML = '';
          let subtotal = 0;
          data.items.forEach(it => {
            const div = document.createElement('div');
            div.style.display='flex';
            div.style.justifyContent='space-between';
            div.style.padding='6px 0';
            div.innerHTML = `<div>${it.qty} x ${it.name}</div><div>RD$${(it.qty*it.price).toFixed(2)}</div>`;
            itemsEl.appendChild(div);
            subtotal += it.qty*it.price;
          });
          const tax = +(subtotal * (data.taxRate||0)).toFixed(2);
          const total = subtotal + tax;
          document.getElementById('confirmSubtotal').textContent = `RD$${subtotal.toFixed(2)}`;
          document.getElementById('confirmTax').textContent = `RD$${tax.toFixed(2)}`;
          document.getElementById('confirmTotal').textContent = `RD$${total.toFixed(2)}`;
          document.getElementById('confirmPayment').value = 'efectivo';
          modal.style.display = 'flex';
          document.getElementById('confirmAccept').onclick = () => {
            const payment = document.getElementById('confirmPayment').value;
            onConfirm && onConfirm({ items: data.items, subtotal, tax, total, payment });
            closeConfirm();
          };
        }

        function closeConfirm() {
          const modal = document.getElementById('confirmModal');
          if (modal) modal.style.display = 'none';
        }

        // expose globally for non-module parts
        window.openConfirm = openConfirm;
        window.closeConfirm = closeConfirm;

        // =============================================
        // MÓDULO POS.JS - POS reutilizable
        // =============================================
        const POS = (() => {
          const carts = { billar: [], barberia: [], carwash: [] };
          const TAX = 0.18;

          function init() {
            document.addEventListener('click', async (e) => {
              if (e.target.matches('.btn-add-to-cart')) {
                const code = e.target.dataset.code;
                const ctx = e.target.dataset.context || 'billar';
                await addByBarcode(code, ctx);
              }
              if (e.target.matches('.btn-change-qty')) {
                const ctx = e.target.dataset.context;
                const idx = +e.target.dataset.index;
                const delta = +e.target.dataset.delta;
                changeQty(ctx, idx, delta);
              }
              if (e.target.matches('.btn-open-confirm')) {
                const ctx = e.target.dataset.context || 'billar';
                openConfirmForContext(ctx);
              }
            });
            renderAll();
          }

          function getCart(ctx) { if (!carts[ctx]) carts[ctx] = []; return carts[ctx]; }

          async function addByBarcode(code, ctx='billar') {
            if (ctx === 'billar') {
              const prod = await getByIndex('productos','por_codigoBarra', code);
              if (!prod) throw new Error('Producto no encontrado');
              addToCart(ctx, { id: prod.id, name: prod.nombre, price: prod.precioVenta || prod.precio, qty:1 });
            } else if (ctx === 'barberia') {
              const svc = await getByIndex('barberia_services','por_codigo', code);
              if (!svc) throw new Error('Servicio no encontrado');
              addToCart(ctx, { id: svc.id, name: svc.nombre, price: svc.precio, qty:1 });
            } else if (ctx === 'carwash') {
              const svc = await getByIndex('carwash_services','por_codigo', code);
              if (!svc) throw new Error('Servicio no encontrado');
              addToCart(ctx, { id: svc.id, name: svc.nombre, price: svc.precio, qty:1 });
            }
            renderCart(ctx);
          }

          function addToCart(ctx, it) {
            const cart = getCart(ctx);
            const found = cart.find(x => x.id === it.id && x.price === it.price);
            if (found) found.qty += it.qty; else cart.push(it);
          }
          
          function changeQty(ctx, idx, delta) {
            const cart = getCart(ctx);
            if (!cart[idx]) return;
            cart[idx].qty += delta;
            if (cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart(ctx);
          }

          function renderCart(ctx) {
            const container = document.getElementById(`cartItems`);
            const subtotalEl = document.getElementById(`cartSubtotal-${ctx}`);
            const totalEl = document.getElementById(`cartTotal`);
            if (!container) return;
            container.innerHTML = '';
            const cart = getCart(ctx);
            let subtotal = 0;
            cart.forEach((it, idx) => {
              const line = document.createElement('div');
              line.className = 'cart-item';
              const total = it.qty * it.price;
              subtotal += total;
              line.innerHTML = `
                <div class="cart-item-info">
                  <div class="cart-item-name">${it.name}</div>
                  <div class="cart-item-price">RD$ ${it.price.toFixed(2)} c/u</div>
                </div>
                <div class="cart-item-actions">
                  <button class="quantity-btn btn-change-qty" data-context="${ctx}" data-index="${idx}" data-delta="-1">-</button>
                  <span>${it.qty}</span>
                  <button class="quantity-btn btn-change-qty" data-context="${ctx}" data-index="${idx}" data-delta="1">+</button>
                </div>
              `;
              container.appendChild(line);
            });
            if (subtotalEl) subtotalEl.textContent = `RD$${subtotal.toFixed(2)}`;
            if (totalEl) totalEl.textContent = `RD$${(subtotal*(1+TAX)).toFixed(2)}`;
            
            // Actualizar contador del carrito
            const cartCount = document.getElementById('cartCount');
            if (cartCount) cartCount.textContent = `${cart.length} productos`;
          }

          function renderAll() { ['billar','barberia','carwash'].forEach(renderCart); }

          async function openConfirmForContext(ctx) {
            const cart = getCart(ctx);
            if (!cart.length) { 
              showToast('Carrito vacío', 'error'); 
              return; 
            }
            openConfirm({ items: cart, taxRate: TAX }, async (sale) => {
              const record = { 
                fecha: new Date().toISOString(), 
                context: ctx, 
                items: sale.items, 
                subtotal: sale.subtotal, 
                tax: sale.tax, 
                total: sale.total, 
                payment: sale.payment, 
                user: localStorage.getItem('currentUser') ? JSON.parse(localStorage.getItem('currentUser')).username : 'admin' 
              };
              await addItem('ventas', record);
              if (ctx === 'billar') {
                for (const it of sale.items) {
                  try {
                    const prod = await getItem('productos', it.id);
                    if (prod && typeof prod.stock === 'number') { 
                      prod.stock = Math.max(0, prod.stock - it.qty); 
                      await putItem('productos', prod); 
                    }
                  } catch(e){ console.warn(e); }
                }
              }
              carts[ctx] = [];
              renderCart(ctx);
              try { 
                await window.Printer.printText(buildTicket(record)); 
              } catch(e){ 
                window.Printer.fallbackPrint(buildTicket(record)); 
              }
              showToast('Venta confirmada correctamente');
            });
          }

          function buildTicket(record) {
            const lines = [];
            lines.push("STARK CLEANE");
            lines.push("Factura: " + (record.id || '-'));
            lines.push("Fecha: " + new Date(record.fecha).toLocaleString());
            lines.push("------------------------");
            record.items.forEach(i => lines.push(`${i.qty} x ${i.name}    RD$${(i.qty*i.price).toFixed(2)}`));
            lines.push("------------------------");
            lines.push(`Subtotal: RD$${record.subtotal.toFixed(2)}`);
            lines.push(`Impuesto: RD$${record.tax.toFixed(2)}`);
            lines.push(`Total: RD$${record.total.toFixed(2)}`);
            lines.push("------------------------");
            lines.push("Gracias por su visita!");
            return lines.join("\n");
          }

          return { init, addByBarcode, addToCartPublic: addToCart, changeQtyPublic: changeQty, renderCart, buildTicket };
        })();
        
        window.POS = POS;

        // =============================================
        // MÓDULO PRINTER.JS - QZ Tray + fallback
        // =============================================
        async function printText(text) {
          if (window.qz) {
            try {
              await qz.websocket.connect();
              const printer = await qz.printers.getDefault();
              const esc = '\x1B' + '@';
              const cut = '\x1D' + 'V' + '\x00';
              const data = [ qz.util.stringToBytes(esc + text + cut) ];
              await qz.print(printer, data);
              await qz.websocket.disconnect();
              return true;
            } catch(e) {
              console.warn("QZ print error", e);
              return fallbackPrint(text);
            }
          } else return fallbackPrint(text);
        }

        function fallbackPrint(text) {
          const w = window.open('', '_blank', 'width=400,height=600');
          if (!w) {
            showToast('Pop-up bloqueado. Permite ventanas emergentes para imprimir.', 'error');
            return false;
          }
          w.document.write(`<pre style="font-family:monospace">${escapeHtml(text)}</pre>`);
          w.document.close();
          w.focus();
          w.print();
          setTimeout(()=> w.close(), 600);
          return true;
        }
        
        function escapeHtml(s) { 
          return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
        }

        window.Printer = { printText, fallbackPrint };

        // =============================================
        // MÓDULO JARVIS.JS - asistente de voz
        // =============================================
        const Jarvis = (() => {
          let recognition = null;
          let listening = false;
          let opts = { wakeWord: "jarvis" };

          function init(options = {}) {
            opts = Object.assign(opts, options);
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRec) { 
              console.warn("SpeechRecognition not supported"); 
              return; 
            }
            recognition = new SpeechRec();
            recognition.lang = 'es-ES';
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onresult = (e) => {
              const text = e.results[e.results.length-1][0].transcript.trim().toLowerCase();
              handleSpoken(text);
            };
            recognition.onend = () => { if (listening) recognition.start(); };
            recognition.onerror = (e) => console.warn("Jarvis SR error", e);
            start();
          }

          function start() {
            if (!recognition) return;
            try { 
              recognition.start(); 
              listening = true; 
              console.log("Jarvis listening..."); 
            } catch(e) { 
              console.warn(e); 
            }
          }
          
          function stop() { 
            listening = false; 
            recognition && recognition.stop(); 
          }

          function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'es-ES'; 
            u.rate = 1; 
            u.pitch = 1;
            window.speechSynthesis.cancel(); 
            window.speechSynthesis.speak(u);
          }

          async function handleSpoken(text) {
            console.log("Jarvis heard:", text);
            const wake = opts.wakeWord.toLowerCase();
            if (!text.includes(wake)) return; // ignore if no wake word
            const cmd = text.replace(wake, '').trim();
            if (!cmd) { 
              speak('Sí, ¿en qué puedo ayudarte?'); 
              return; 
            }

            // Navigation commands
            if (/barber/i.test(cmd) || /barbería/i.test(cmd)) { 
              showView('barberia');
              speak('Abriendo barbería'); 
              return; 
            }
            
            if (/billar/i.test(cmd)) { 
              showView('billar');
              speak('Abriendo billar'); 
              return; 
            }
            
            if (/car wash|lavado|auto/i.test(cmd)) { 
              showView('carwash');
              speak('Abriendo car wash'); 
              return; 
            }

            // Create appointment (simple flow)
            if (/agenda|agendar|cita/.test(cmd)) {
              speak('Perfecto, dime el nombre del cliente, por favor.');
              // To implement: state machine to capture follow-up phrases (name, date, time)
              // For now, fallback to AI to parse if available
              return;
            }

            // Add product by voice (e.g., "agrega dos cervezas presidente")
            if (/agrega|añade|pon/.test(cmd)) {
              // try naive parse: qty + name
              const m = cmd.match(/(\d+|una|un|dos|tres|cuatro|cinco)\s+(.+)/);
              let qty = 1; 
              let name = null;
              if (m) {
                const qRaw = m[1];
                qty = isNaN(parseInt(qRaw)) ? (qRaw.includes('dos')?2:(qRaw.includes('tres')?3:1)) : parseInt(qRaw);
                name = m[2].trim();
              } else {
                const m2 = cmd.match(/agrega\s+(.+)/);
                if (m2) name = m2[1].trim();
              }
              if (name) {
                const prods = await getAll('productos');
                const found = prods.find(p => p.nombre.toLowerCase().includes(name.split(' ')[0]));
                if (found) {
                  const active = document.querySelector('[data-active-module]')?.getAttribute('data-active-module') || 'billar';
                  window.POS.addToCartPublic(active, { id: found.id, name: found.nombre, price: found.precioVenta || found.precio, qty });
                  speak(`Agregado ${qty} ${found.nombre}`);
                  return;
                } else { 
                  speak('No encontré ese producto localmente. ¿Quieres que lo busque en el inventario?'); 
                  return; 
                }
              }
            }

            // Confirm sale
            if (/confirmar venta|cobrar|pagar/.test(cmd)) {
              const active = document.querySelector('[data-active-module]')?.getAttribute('data-active-module') || 'billar';
              document.querySelector(`.btn-open-confirm[data-context="${active}"]`)?.click() || document.getElementById('btn-open-confirm')?.click();
              speak('Abriendo confirmación de venta');
              return;
            }

            // Stock query
            if (/cuantas.*quedan|stock|tiene.*stock/.test(cmd)) {
              const prods = await getAll('productos');
              let guessed = null;
              for (const p of prods) { 
                if (cmd.includes(p.nombre.toLowerCase().split(' ')[0])) { 
                  guessed = p; 
                  break; 
                } 
              }
              if (guessed) { 
                speak(`${guessed.nombre} quedan ${guessed.stock || 0} unidades`); 
                return; 
              }
              speak('Dime el nombre del producto y te digo el stock.');
              return;
            }

            // fallback to AI endpoint if available
            try {
              const res = await fetch('/api/ai', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body: JSON.stringify({ 
                  text: cmd, 
                  context: { 
                    module: document.querySelector('[data-active-module]')?.getAttribute('data-active-module') 
                  } 
                }) 
              });
              if (res.ok) {
                const json = await res.json();
                if (json.reply) speak(json.reply);
                if (json.action) handleAIAction(json.action);
              } else speak('No pude procesar tu petición, intenta de nuevo.');
            } catch(e) {
              console.warn('AI fallback error', e);
              speak('Lo siento, hubo un error procesando la solicitud.');
            }
          }

          async function handleAIAction(action) {
            // Example action: { type:'create_appointment', payload:{name:'Juan', date:'2025-12-01', time:'15:00'} }
            if (!action) return;
            if (action.type === 'create_appointment') {
              const p = action.payload;
              await addItem('barberia_citas', { 
                cliente: p.name, 
                fecha: p.date+' '+(p.time||'00:00'), 
                servicio: p.service||'General', 
                barbero: p.barbero||'Sin asignar', 
                estado: 'pendiente' 
              });
              speak('Cita creada correctamente.');
              return;
            }
            // add more handlers as needed
          }

          return { init, start, stop, speak };
        })();
        
        window.Jarvis = Jarvis;

        // =============================================
        // INICIALIZACIÓN DEL SISTEMA
        // =============================================
        document.addEventListener('DOMContentLoaded', async function() {
          // Inicializar usuarios por defecto
          await initDefaultUsers();
          
          // Configurar event listeners de autenticación
          setupAuthListeners();
          
          // Configurar tema
          setupTheme();
          
          // Configurar AI Assistant
          setupAIAssistant();
          
          // Si ya hay usuario en localStorage, iniciar sesión automáticamente
          const savedUser = localStorage.getItem('currentUser');
          if (savedUser) {
            try {
              const user = JSON.parse(savedUser);
              await login(user.username, user.password);
            } catch (e) {
              localStorage.removeItem('currentUser');
            }
          }
        });

        function setupAuthListeners() {
          // Login form
          document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            
            const result = await login(username, password);
            if (!result.success) {
              document.getElementById('loginError').textContent = result.error;
              document.getElementById('loginError').style.display = 'block';
              setTimeout(() => {
                document.getElementById('loginError').style.display = 'none';
              }, 3000);
            }
          });
          
          // Register form
          document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nombre = document.getElementById('regName').value;
            const username = document.getElementById('regUser').value;
            const password = document.getElementById('regPass').value;
            const rol = document.getElementById('regRole').value;
            
            const result = await register({ nombre, username, password, rol });
            if (result.success) {
              showToast('Usuario registrado correctamente');
              toggleAuth('login');
              document.getElementById('registerForm').reset();
            } else {
              showToast(result.error, 'error');
            }
          });
        }

        function setupTheme() {
          const themeToggle = document.getElementById('themeToggle');
          const selectTema = document.getElementById('select-tema');
          
          if (themeToggle) {
            themeToggle.addEventListener('click', function () {
              if (document.body.classList.contains('dark-mode')) {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                this.innerHTML = '<i class="fas fa-sun"></i>';
                if (selectTema) selectTema.value = "light";
              } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                this.innerHTML = '<i class="fas fa-moon"></i>';
                if (selectTema) selectTema.value = "dark";
              }
            });
          }
          
          if (selectTema) {
            selectTema.addEventListener('change', function () {
              if (this.value === "light") {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
                if (themeToggle) themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
              } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                if (themeToggle) themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
              }
            });
          }
          
          // Botón guardar tema
          const saveThemeBtn = document.getElementById('saveThemeBtn');
          if (saveThemeBtn) {
            saveThemeBtn.addEventListener('click', function() {
              showToast('Configuración de tema guardada');
            });
          }
        }

        function setupAIAssistant() {
          const aiButton = document.getElementById('aiButton');
          const aiChat = document.getElementById('aiChat');
          const aiClose = document.getElementById('aiClose');
          const aiSend = document.getElementById('aiSend');
          const aiInput = document.getElementById('aiInput');
          const aiMessages = document.getElementById('aiMessages');

          if (aiButton) {
            aiButton.addEventListener('click', () => {
              aiChat.classList.toggle('active');
            });
          }

          if (aiClose) {
            aiClose.addEventListener('click', () => {
              aiChat.classList.remove('active');
            });
          }

          if (aiSend && aiInput) {
            aiSend.addEventListener('click', sendAIMessage);
            aiInput.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                sendAIMessage();
              }
            });
          }

          function sendAIMessage() {
            const message = aiInput.value.trim();
            if (!message) return;

            // Agregar mensaje del usuario
            addAIMessage(message, 'user');
            aiInput.value = '';

            // Simular respuesta de IA
            setTimeout(() => {
              const response = generateAIResponse(message);
              addAIMessage(response, 'assistant');
            }, 1000);
          }

          function addAIMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${sender}`;
            messageDiv.textContent = text;
            aiMessages.appendChild(messageDiv);
            aiMessages.scrollTop = aiMessages.scrollHeight;
          }

          function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();

            // Respuestas predefinidas según palabras clave
            if (lowerMessage.includes('hola') || lowerMessage.includes('buenos días') || lowerMessage.includes('buenas tardes')) {
              return "¡Hola! Soy tu asistente de IA. ¿En qué puedo ayudarte hoy?";
            } else if (lowerMessage.includes('producto') || lowerMessage.includes('inventario')) {
              return "Puedo ayudarte con la gestión de inventario. ¿Quieres agregar un nuevo producto, verificar el stock o algo más específico?";
            } else if (lowerMessage.includes('venta') || lowerMessage.includes('punto de venta')) {
              return "Para realizar una venta, ve a la sección de Punto de Venta y agrega productos al carrito. Luego confirma la venta en el modal de pago.";
            } else if (lowerMessage.includes('cita') || lowerMessage.includes('barbería')) {
              return "En la sección de Barbería puedes gestionar citas, ver el historial y realizar ventas de servicios.";
            } else if (lowerMessage.includes('car wash') || lowerMessage.includes('lavado')) {
              return "En Car Wash puedes registrar vehículos, gestionar servicios y realizar ventas.";
            } else if (lowerMessage.includes('reporte') || lowerMessage.includes('estadística')) {
              return "Puedes generar reportes en la sección de Reportes. Allí encontrarás gráficos y estadísticas de ventas.";
            } else if (lowerMessage.includes('usuario') || lowerMessage.includes('registro')) {
              return "Para gestionar usuarios, ve a Configuración > Usuarios. Allí puedes agregar, editar o eliminar usuarios.";
            } else if (lowerMessage.includes('backup') || lowerMessage.includes('respaldo')) {
              return "Puedes realizar backup de tus datos en Configuración > Gestión de Datos. Esto te permitirá restaurar la información más tarde.";
            } else if (lowerMessage.includes('gracias')) {
              return "¡De nada! Estoy aquí para ayudarte. ¿Hay algo más en lo que pueda asistirte?";
            } else {
              return "Lo siento, no entiendo completamente tu pregunta. ¿Podrías ser más específico? Puedo ayudarte con inventario, ventas, citas, reportes y configuración del sistema.";
            }
          }
        }

        // =============================================
        // FUNCIONES GLOBALES
        // =============================================
        function showToast(message, type = "success") {
          const toastContainer = document.getElementById("toast-container");
          if (!toastContainer) return;
          
          const toast = document.createElement("div");
          toast.className = `toast-custom ${type === "error" ? "toast-error" : ""}`;
          toast.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <i class="fas ${type === "error" ? "fa-exclamation-circle" : "fa-check-circle"} me-2"></i>
                ${message}
              </div>
              <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer;">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
          
          toastContainer.appendChild(toast);
          setTimeout(() => {
            if (toast.parentNode) toast.remove();
          }, 4000);
        }

        // Función para cambiar entre login/register
        window.toggleAuth = function(view) {
          if (view === 'register') {
            document.getElementById('loginFormBox').classList.add('hidden');
            document.getElementById('registerFormBox').classList.remove('hidden');
          } else {
            document.getElementById('registerFormBox').classList.add('hidden');
            document.getElementById('loginFormBox').classList.remove('hidden');
          }
        };

        window.logout = logout;
        window.showToast = showToast;

        console.log("STARK CLEANE System modules loaded successfully");
    </script>
</body>
</html>
